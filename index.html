<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Simulador de Estacionamento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Roboto', sans-serif;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    
    #map {
      height: 100%;
      width: 100%;
      z-index: 1;
    }
    
    #header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #3a7bd5, #00d2ff);
      color: white;
      padding: 10px 20px;
      text-align: center;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    #header h1 {
      font-size: 1.2rem;
      margin: 0;
    }
    
    #info-panel {
      position: absolute;
      top: 60px;
      left: 10px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 15px rgba(0,0,0,0.15);
      z-index: 1000;
      max-width: 300px;
      transition: transform 0.3s ease;
    }
    
    #info-panel.hidden {
      transform: translateX(-110%);
    }
    
    #info-toggle {
      position: absolute;
      top: 70px;
      left: 10px;
      background: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      cursor: pointer;
      z-index: 999;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    #info-toggle.visible {
      opacity: 1;
    }
    
    .car-dimensions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    
    .dimension-input {
      flex: 1;
      min-width: 120px;
    }
    
    .dimension-input label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 5px;
      color: #555;
    }
    
    .dimension-input input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    #apply-dimensions {
      background: #3a7bd5;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      margin-top: 10px;
      cursor: pointer;
      width: 100%;
      transition: background 0.2s;
    }
    
    #apply-dimensions:hover {
      background: #2a6ac5;
    }
    
    .status-indicator {
      display: flex;
      align-items: center;
      margin-top: 10px;
      padding: 8px;
      border-radius: 4px;
      background: #f0f0f0;
    }
    
    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-text {
      font-size: 0.9rem;
    }
    
    .status-perfect .status-dot {
      background: #4CAF50;
    }
    
    .status-good .status-dot {
      background: #2196F3;
    }
    
    .status-adjust .status-dot {
      background: #FF9800;
    }
    
    .status-warning .status-dot {
      background: #F44336;
    }
    
    .status-perfect {
      background: rgba(76, 175, 80, 0.1);
    }
    
    .status-good {
      background: rgba(33, 150, 243, 0.1);
    }
    
    .status-adjust {
      background: rgba(255, 152, 0, 0.1);
    }
    
    .status-warning {
      background: rgba(244, 67, 54, 0.1);
    }
    
    #controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 1000;
    }
    
    .control-btn {
      background: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .control-btn:active {
      transform: scale(0.95);
    }
    
    .control-btn svg {
      width: 24px;
      height: 24px;
    }
    
    #compass {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: white;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    
    #compass-needle {
      width: 24px;
      height: 24px;
      transform-origin: center;
      transition: transform 0.2s ease;
    }
    
    .leaflet-control-attribution {
      font-size: 10px;
    }
    
    @media (max-width: 768px) {
      #info-panel {
        max-width: 90%;
      }
      
      .car-dimensions {
        flex-direction: column;
        gap: 8px;
      }
      
      #controls {
        bottom: 10px;
      }
      
      .control-btn {
        width: 45px;
        height: 45px;
      }
    }
  </style>
</head>
<body>
  <div id="header">
    <h1>Simulador de Estacionamento</h1>
  </div>
  
  <div id="map"></div>
  
  <div id="info-panel">
    <h2>Configurações</h2>
    <p>Ajuste as dimensões do seu veículo para melhor precisão:</p>
    
    <div class="car-dimensions">
      <div class="dimension-input">
        <label for="car-length">Comprimento (m)</label>
        <input type="number" id="car-length" value="4.5" min="2" max="10" step="0.1">
      </div>
      <div class="dimension-input">
        <label for="car-width">Largura (m)</label>
        <input type="number" id="car-width" value="2.0" min="1" max="5" step="0.1">
      </div>
    </div>
    
    <button id="apply-dimensions">Aplicar Dimensões</button>
    
    <div class="status-indicator status-adjust">
      <div class="status-dot"></div>
      <div class="status-text">Posicione seu veículo na vaga</div>
    </div>
    
    <div style="margin-top: 10px; font-size: 0.8rem; color: #666;">
      Use os botões abaixo para ajustar a posição da vaga
    </div>
  </div>
  
  <button id="info-toggle" class="hidden">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="16" x2="12" y2="12"></line>
      <line x1="12" y1="8" x2="12.01" y2="8"></line>
    </svg>
  </button>
  
  <div id="controls">
    <button class="control-btn" id="move-up">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#3a7bd5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="18 15 12 9 6 15"></polyline>
      </svg>
    </button>
    <button class="control-btn" id="move-left">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#3a7bd5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
    </button>
    <button class="control-btn" id="recenter">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#3a7bd5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <circle cx="12" cy="12" r="3"></circle>
      </svg>
    </button>
    <button class="control-btn" id="move-right">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#3a7bd5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    </button>
    <button class="control-btn" id="move-down">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#3a7bd5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="6 9 12 15 18 9"></polyline>
      </svg>
    </button>
  </div>
  
  <div id="compass">
    <svg id="compass-needle" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path fill="#E53935" d="M12 2L8 12H16L12 2Z" />
      <path fill="#3F51B5" d="M12 22L16 12H8L12 22Z" />
    </svg>
  </div>

  <script>
    // Variáveis globais
    let map, userMarker, parkingRect, userLocation;
    let carLength = 4.5; // metros
    let carWidth = 2.0; // metros
    let heading = 0;
    let watchId;
    
    // Constantes para conversão de metros para coordenadas
    // Estas são aproximações e variam conforme a latitude
    const METERS_PER_LAT = 111111; // 1 grau de latitude ≈ 111111 metros
    
    // Inicializa o aplicativo
    function initApp() {
      // Configura os listeners de eventos para os botões
      document.getElementById('apply-dimensions').addEventListener('click', updateCarDimensions);
      document.getElementById('move-up').addEventListener('click', () => moveSpot(0, 1));
      document.getElementById('move-down').addEventListener('click', () => moveSpot(0, -1));
      document.getElementById('move-left').addEventListener('click', () => moveSpot(-1, 0));
      document.getElementById('move-right').addEventListener('click', () => moveSpot(1, 0));
      document.getElementById('recenter').addEventListener('click', recenterMap);
      
      const infoPanel = document.getElementById('info-panel');
      const infoToggle = document.getElementById('info-toggle');
      
      infoToggle.addEventListener('click', () => {
        infoPanel.classList.toggle('hidden');
        infoToggle.classList.toggle('visible');
      });
      
      // Inicia o mapa se a geolocalização estiver disponível
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          initMap, 
          handleLocationError,
          { enableHighAccuracy: true }
        );
        
        // Observa mudanças na posição do usuário
        watchId = navigator.geolocation.watchPosition(
          updatePosition, 
          handleLocationError, 
          {
            enableHighAccuracy: true,
            maximumAge: 0,
            timeout: 5000
          }
        );
      } else {
        alert("Geolocalização não é suportada pelo seu navegador.");
      }
    }
    
    // Inicializa o mapa com a posição do usuário
    function initMap(position) {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      userLocation = { lat, lng };
      
      // Calcula o fator de conversão de metros para longitude nesta latitude
      const METERS_PER_LNG = METERS_PER_LAT * Math.cos(lat * Math.PI / 180);
      
      // Cria o mapa
      map = L.map('map', {
        center: [lat, lng],
        zoom: 19,
        zoomControl: false
      });
      
      // Adiciona controles de zoom no canto inferior esquerdo
      L.control.zoom({
        position: 'bottomleft'
      }).addTo(map);
      
      // Adiciona camada de mapa base
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 22,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);
      
      // Cria o marcador do usuário
      const userIcon = L.divIcon({
        className: 'user-marker',
        html: `<svg width="20" height="20" viewBox="0 0 24 24" fill="#3a7bd5" stroke="#ffffff" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
               </svg>`,
        iconSize: [20, 20],
        iconAnchor: [10, 10]
      });
      
      userMarker = L.marker([lat, lng], {
        icon: userIcon,
        zIndexOffset: 1000
      }).addTo(map);
      
      // Cria a vaga de estacionamento
      createParkingSpot(userLocation);
      
      // Atualiza a bússola se o dispositivo suportar
      if (position.coords.heading !== null) {
        heading = position.coords.heading;
        updateCompass(heading);
      }
    }
    
    // Cria a vaga de estacionamento
    function createParkingSpot(location) {
      // Calcula o fator de conversão de metros para longitude nesta latitude
      const METERS_PER_LNG = METERS_PER_LAT * Math.cos(location.lat * Math.PI / 180);
      
      // Calcula as dimensões da vaga em coordenadas
      const halfWidthLat = (carWidth / 2) / METERS_PER_LAT;
      const halfLengthLng = (carLength / 2) / METERS_PER_LNG;
      
      const bounds = [
        [location.lat - halfWidthLat, location.lng - halfLengthLng],
        [location.lat + halfWidthLat, location.lng + halfLengthLng]
      ];
      
      // Remove a vaga anterior se existir
      if (parkingRect) {
        map.removeLayer(parkingRect);
      }
      
      // Cria o retângulo da vaga
      parkingRect = L.rectangle(bounds, {
        color: "#4CAF50",
        weight: 2,
        fillColor: "#4CAF50",
        fillOpacity: 0.3
      }).addTo(map);
      
      // Adiciona marcadores nas extremidades da vaga
      addParkingMarkers(bounds);
      
      // Verifica o alinhamento
      checkAlignment();
    }
    
    // Adiciona marcadores nas extremidades da vaga
    function addParkingMarkers(bounds) {
      // Cria marcadores nos cantos da vaga
      const corners = [
        [bounds[0][0], bounds[0][1]], // SW
        [bounds[0][0], bounds[1][1]], // SE
        [bounds[1][0], bounds[0][1]], // NW
        [bounds[1][0], bounds[1][1]]  // NE
      ];
      
      corners.forEach(corner => {
        const cornerIcon = L.divIcon({
          className: 'corner-marker',
          html: `<svg width="10" height="10" viewBox="0 0 10 10">
                  <circle cx="5" cy="5" r="4" fill="#4CAF50" stroke="#ffffff" stroke-width="1"/>
                 </svg>`,
          iconSize: [10, 10],
          iconAnchor: [5, 5]
        });
        
        L.marker(corner, {
          icon: cornerIcon
        }).addTo(map);
      });
    }
    
    // Atualiza a posição do usuário
    function updatePosition(position) {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      userLocation = { lat, lng };
      
      // Atualiza o marcador do usuário
      if (userMarker) {
        userMarker.setLatLng([lat, lng]);
      }
      
      // Atualiza a bússola se o dispositivo suportar
      if (position.coords.heading !== null) {
        heading = position.coords.heading;
        updateCompass(heading);
      }
      
      // Verifica o alinhamento com a vaga
      checkAlignment();
    }
    
    // Move a vaga de estacionamento
    function moveSpot(x, y) {
      if (!parkingRect) return;
      
      const bounds = parkingRect.getBounds();
      const center = bounds.getCenter();
      
      // Calcula o fator de conversão de metros para longitude nesta latitude
      const METERS_PER_LNG = METERS_PER_LAT * Math.cos(center.lat * Math.PI / 180);
      
      // Calcula o deslocamento (0.5 metros por clique)
      const latOffset = y * 0.5 / METERS_PER_LAT;
      const lngOffset = x * 0.5 / METERS_PER_LNG;
      
      const newCenter = {
        lat: center.lat + latOffset,
        lng: center.lng + lngOffset
      };
      
      // Recria a vaga na nova posição
      createParkingSpot(newCenter);
    }
    
    // Atualiza as dimensões do carro
    function updateCarDimensions() {
      const lengthInput = document.getElementById('car-length');
      const widthInput = document.getElementById('car-width');
      
      const newLength = parseFloat(lengthInput.value);
      const newWidth = parseFloat(widthInput.value);
      
      // Valida os valores
      if (isNaN(newLength) || isNaN(newWidth) || newLength < 2 || newWidth < 1) {
        alert("Por favor, insira dimensões válidas.");
        return;
      }
      
      carLength = newLength;
      carWidth = newWidth;
      
      // Recria a vaga com as novas dimensões
      if (parkingRect) {
        const center = parkingRect.getBounds().getCenter();
        createParkingSpot({lat: center.lat, lng: center.lng});
      }
    }
    
    // Recentra o mapa na posição do usuário
    function recenterMap() {
      if (map && userLocation) {
        map.setView([userLocation.lat, userLocation.lng], 19);
      }
    }
    
    // Verifica o alinhamento do usuário com a vaga
    function checkAlignment() {
      if (!parkingRect || !userLocation) return;
      
      const center = parkingRect.getBounds().getCenter();
      
      // Calcula a distância entre o usuário e o centro da vaga
      const distance = getDistance(
        userLocation.lat, 
        userLocation.lng, 
        center.lat, 
        center.lng
      );
      
      // Atualiza o indicador de status
      const statusIndicator = document.querySelector('.status-indicator');
      const statusText = document.querySelector('.status-text');
      
      statusIndicator.className = 'status-indicator';
      
      if (distance < 1) {
        statusIndicator.classList.add('status-perfect');
        statusText.textContent = 'Posicionamento perfeito!';
      } else if (distance < 2) {
        statusIndicator.classList.add('status-good');
        statusText.textContent = 'Bom posicionamento';
      } else if (distance < 4) {
        statusIndicator.classList.add('status-adjust');
        statusText.textContent = 'Ajuste a posição';
      } else {
        statusIndicator.classList.add('status-warning');
        statusText.textContent = 'Muito distante da vaga';
      }
    }
    
    // Calcula a distância entre dois pontos em metros usando a fórmula de Haversine
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3; // raio da Terra em metros
      const φ1 = lat1 * Math.PI / 180;
      const φ2 = lat2 * Math.PI / 180;
      const Δφ = (lat2 - lat1) * Math.PI / 180;
      const Δλ = (lon2 - lon1) * Math.PI / 180;
      
      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      
      return R * c;
    }
    
    // Atualiza a bússola
    function updateCompass(degrees) {
      const needle = document.getElementById('compass-needle');
      if (needle) {
        needle.style.transform = `rotate(${degrees}deg)`;
      }
    }
    
    // Trata erros de geolocalização
    function handleLocationError(error) {
      let message;
      
      switch(error.code) {
        case error.PERMISSION_DENIED:
          message = "Usuário negou a solicitação de geolocalização.";
          break;
        case error.POSITION_UNAVAILABLE:
          message = "Informações de localização indisponíveis.";
          break;
        case error.TIMEOUT:
          message = "Tempo esgotado ao solicitar localização.";
          break;
        case error.UNKNOWN_ERROR:
          message = "Ocorreu um erro desconhecido.";
          break;
      }
      
      alert(`Erro de geolocalização: ${message}`);
    }
    
    // Limpa o observador de posição quando a página é fechada
    window.addEventListener('beforeunload', () => {
      if (watchId) {
        navigator.geolocation.clearWatch(watchId);
      }
    });
    
    // Inicia o aplicativo quando a página carrega
    window.addEventListener('load', initApp);
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'964a3fc3469fca0a',t:'MTc1MzQzMTc0Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
